# 批次通知功能說明

## 功能概述

當短時間內有大量檔案變動時(例如一次上傳 100 個 .rfa 檔案),程式會自動啟用批次通知模式,將多個變動合併成一則訊息,避免 Slack 被洗版。

## 運作原理

### 觸發條件

批次通知會在以下情況自動啟用:

1. **檔案數量超過閾值**
   - 預設:10 個檔案(可在設定中調整 5-50)
   
2. **時間窗口內的變動**
   - 預設:10 秒內(可在設定中調整 5-60 秒)

### 範例情境

**情境 1: 一次上傳 100 個檔案**
```
14:30:00 - 開始上傳
14:30:15 - 上傳完成
結果: 發送 1 則批次通知 ✅
```

**情境 2: 零星修改檔案**
```
14:30:00 - 修改檔案 A
14:32:00 - 修改檔案 B (超過時間窗口)
14:35:00 - 修改檔案 C
結果: 發送 3 則個別通知 ✅
```

**情境 3: 混合情境**
```
14:30:00 - 上傳 20 個檔案 (觸發批次)
14:35:00 - 修改 2 個檔案 (個別通知)
結果: 1 則批次通知 + 2 則個別通知 ✅
```

## 批次通知內容

### Slack 訊息格式

```
📦 批次檔案變動 (共 100 個檔案)

📊 變動統計:
  📁 新增: 85 個
  ✏️ 修改: 10 個
  🗑️ 刪除: 5 個

📂 主要路徑: 結構\鋼構
⏰ 時間範圍: 14:30:00 - 14:30:15

📋 部分檔案清單:
  📁 `H型鋼-300x150.rfa`
  📁 `H型鋼-400x200.rfa`
  📁 `I型鋼-250x125.rfa`
  ... 還有 97 個檔案

💡 提示: 檢查是否為批次同步或上傳操作
```

## Webhook 資料格式

### 批次通知 JSON

```json
{
  "event_type": "batch",
  "total_count": 100,
  "created_count": 85,
  "modified_count": 10,
  "deleted_count": 5,
  "start_time": "2025-11-17T14:30:00+08:00",
  "end_time": "2025-11-17T14:30:15+08:00",
  "common_path": "結構\\鋼構",
  "files": [
    {
      "fileName": "H型鋼-300x150.rfa",
      "relativePath": "結構\\鋼構\\H型鋼-300x150.rfa",
      "eventType": "created"
    },
    {
      "fileName": "H型鋼-400x200.rfa",
      "relativePath": "結構\\鋼構\\H型鋼-400x200.rfa",
      "eventType": "created"
    }
    // ... 最多回傳前 20 個檔案
  ]
}
```

### 單一通知 JSON (不變)

```json
{
  "event_type": "created",
  "file_name": "H型鋼.rfa",
  "file_path": "\\\\NAS\\族群庫\\結構\\H型鋼.rfa",
  "relative_path": "結構\\H型鋼.rfa",
  "timestamp": "2025-11-17T14:30:00+08:00",
  "old_name": null
}
```

## 設定方式

### 程式設定介面

右鍵托盤圖示 → **設定** → **批次通知設定**

1. **啟用智慧批次通知**
   - 勾選以啟用此功能
   - 取消勾選則所有變動都會個別通知

2. **批次閾值**
   - 範圍: 5-50 個檔案
   - 建議: 10 個
   - 說明: 超過此數量才會合併

3. **批次時間窗口**
   - 範圍: 5-60 秒
   - 建議: 10 秒
   - 說明: 此時間內的變動會被視為一批

### 設定檔 (config.json)

```json
{
  "EnableBatchNotification": true,
  "BatchThreshold": 10,
  "BatchWindowSeconds": 10
}
```

## n8n Workflow 設定

使用 `n8n-workflow-batch.json` 範例檔案:

### Workflow 結構

```
[Webhook]
    ↓
[判斷: 是否為批次?]
    ↓               ↓
[批次格式化]    [單一格式化]
    ↓               ↓
    └──→ [Slack] ←─┘
```

### 匯入步驟

1. 在 n8n 中點擊 **Import from File**
2. 選擇 `n8n-workflow-batch.json`
3. 設定 Slack credentials
4. 修改頻道名稱 (預設 `#revit-alerts`)
5. 測試 Webhook

## 日誌記錄

即使啟用批次通知,程式仍會在日誌中記錄每個檔案的詳細資訊:

```
[2025-11-17 14:30:00] [Info] 開始處理批次變動: 100 個檔案
[2025-11-17 14:30:00] [Info] 新增: 結構\鋼構\H型鋼-300x150.rfa
[2025-11-17 14:30:00] [Info] 新增: 結構\鋼構\H型鋼-400x200.rfa
...
[2025-11-17 14:30:01] [Info] 批次通知已發送: 100 個檔案變動
```

## 效能影響

### 批次模式 vs 個別模式

**100 個檔案上傳時:**

| 模式 | Webhook 請求數 | Slack 訊息數 | 處理時間 |
|------|---------------|--------------|----------|
| 個別模式 | 100 | 100 | ~30 秒 |
| 批次模式 | 1 | 1 | <1 秒 |

### 優勢

✅ 減少網路請求  
✅ 避免 API 限流  
✅ Slack 訊息更清晰  
✅ 更快的處理速度  
✅ 降低伺服器負載  

## 常見問題

### Q: 批次通知會漏掉檔案嗎?

**A:** 不會。所有檔案都會記錄在日誌中,批次通知只是改變「通知方式」,不影響監控完整性。

### Q: 可以看到批次中的所有檔案嗎?

**A:** Slack 訊息會顯示前 10 個檔案,完整清單可以在程式日誌中查看。

### Q: 如何調整批次閾值?

**A:** 
- **設定較低 (5-8)**: 更早觸發批次,適合不常大量上傳的環境
- **設定較高 (15-20)**: 更晚觸發批次,保留更多個別通知

### Q: 批次時間窗口要設多少?

**A:**
- **較短 (5-8 秒)**: 更嚴格的批次判定,減少誤判
- **較長 (15-30 秒)**: 更寬鬆的批次判定,更容易合併

### Q: 可以完全關閉批次功能嗎?

**A:** 可以,在設定中取消勾選「啟用智慧批次通知」即可。

### Q: 會影響現有的 n8n workflow 嗎?

**A:** 
- 使用 `n8n-workflow-batch.json`: 完整支援批次和個別通知
- 使用舊的 workflow: 只需加入判斷邏輯即可相容

## 測試建議

### 測試批次功能

1. **準備測試檔案**
   - 複製 15-20 個 .rfa 檔案

2. **執行批次上傳**
   - 一次性貼到 NAS 資料夾
   - 應該觸發批次通知

3. **檢查結果**
   - Slack 收到 1 則批次訊息
   - 日誌中有所有檔案記錄
   - 最近通知視窗顯示批次項目

### 測試個別通知

1. **單一檔案變動**
   - 修改或新增 1 個檔案
   - 應該收到個別通知

2. **間隔變動**
   - 每隔 15 秒修改 1 個檔案
   - 每次都應該是個別通知

## 進階設定

### 自訂批次邏輯

如果需要更複雜的批次判定,可以修改 `FileWatcherService.cs` 中的 `ProcessPendingChanges` 方法:

```csharp
// 範例: 只有「新增」才批次,修改和刪除保持個別通知
if (itemsToProcess.All(x => IsCreatedFile(x.Key)))
{
    ProcessBatchChanges(itemsToProcess);
}
else
{
    // 個別處理
}
```

### 依路徑批次

```csharp
// 範例: 同一資料夾內的變動才批次
var grouped = itemsToProcess
    .GroupBy(x => Path.GetDirectoryName(x.Key))
    .Where(g => g.Count() >= _config.BatchThreshold);

foreach (var group in grouped)
{
    ProcessBatchChanges(group.ToList());
}
```

## 更新日誌

### v1.1.0 (2025-11-17)
- ✨ 新增批次通知功能
- ✨ 可自訂批次閾值和時間窗口
- 🎨 優化設定介面
- 📝 更新 n8n workflow 範例

---

如有問題或建議,歡迎回報! 🚀
